<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 3</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>

    <script type="text/javascript">

        var config = {
            type: Phaser.AUTO,
            width: 4000,
            height: 600,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 1100 },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var platforms;
        var tuberia;
        var cursors;
        var toque = true;
        var crebote = true;
        var tamaño = "grande";
        var timedEvent;
        var partida;
        var game = new Phaser.Game(config);

        function preload() {
            this.load.image('sky', 'assets/sky.png');
            this.load.image('nube', 'assets/nube.png');
            this.load.image('ground', 'assets/ground.png');
            this.load.image('defaultBrick', 'assets/brick.png');
            this.load.image('itemBrick', 'assets/itemBlock.png');
            this.load.image('bullet', 'assets/bulletbill.png');
            this.load.image('cannon', 'assets/cannon.png');
            this.load.image('caparazon', 'assets/caparazon.png');
            this.load.spritesheet('koopa', 'assets/koopa.png', { frameWidth: 100, frameHeight: 140 });
            this.load.image('tuberia', 'assets/tuberia.png');
            this.load.image('tuberiaTP', 'assets/tuberiaTP.png');
            this.load.spritesheet('goomba', 'assets/goomba.png', { frameWidth: 200, frameHeight: 160 });
            this.load.spritesheet('player', 'assets/mariosprite.png', { frameWidth: 64.185, frameHeight: 100 });
            this.load.image('seta', 'assets/seta.png');
        }

        function create() {
            partida = 1;
            nubes = this.physics.add.staticGroup();
            bullet = this.physics.add.staticGroup();
            platforms = this.physics.add.staticGroup();
            mushroombrick = this.physics.add.staticGroup();
            tuberia = this.physics.add.staticGroup();
            caparazones = this.physics.add.group();
            setas = this.physics.add.group();
            cannon = this.physics.add.staticGroup();


            for (let i = 0; i < 20; i++) {
                this.add.image(i * 400, 400, 'sky');
                this.add.image(i * 400, 50, 'sky');
            };
            this.add.image(3600, 500, 'sky');
            nubes.create(800, 200, 'nube').setScale(1).refreshBody();
            nubes.create(1300, 250, 'nube').setScale(1).refreshBody();
            nubes.create(400, 150, 'nube').setScale(1).refreshBody();
            nubes.create(1800, 250, 'nube').setScale(1).refreshBody();
            nubes.create(2700, 250, 'nube').setScale(1).refreshBody();
            nubes.create(2000, 150, 'nube').setScale(1).refreshBody();
            tuberia.create(1800, 550, 'tuberia').setScale(0.3).refreshBody();
            tuberia.create(2030, 470, 'tuberia').setScale(0.3).refreshBody();
            tuberia.create(2400, 550, 'tuberia').setScale(0.3).refreshBody();


            for (let i = 0; i < 134; i++) {
                platforms.create(i * 30, 585, 'ground').setScale(0.2).refreshBody();
            };

            platforms.create(1000, 450, 'defaultBrick').setScale(0.2).refreshBody();
            mushroombrick.create(1030, 450, 'itemBrick').setScale(0.2).refreshBody();
            platforms.create(1060, 450, 'defaultBrick').setScale(0.2).refreshBody();
            platforms.create(1090, 450, 'itemBrick').setScale(0.2).refreshBody();
            platforms.create(1120, 450, 'defaultBrick').setScale(0.2).refreshBody();


            platforms.create(1300, 400, 'defaultBrick').setScale(0.2).refreshBody();
            platforms.create(1330, 400, 'itemBrick').setScale(0.21).refreshBody();
            platforms.create(1360, 400, 'defaultBrick').setScale(0.2).refreshBody();
            platforms.create(1390, 400, 'defaultBrick').setScale(0.2).refreshBody();
            platforms.create(1420, 400, 'itemBrick').setScale(0.21).refreshBody();
            platforms.create(1450, 400, 'defaultBrick').setScale(0.2).refreshBody();



            player = this.physics.add.sprite(3500, 500, 'player').setScale(0.7);
            koopa1 = this.physics.add.sprite(3000, 500, 'koopa').setScale(0.5);
            goomba2 = this.physics.add.sprite(2200, 350, 'goomba').setScale(0.22);
            goomba1 = this.physics.add.sprite(1750, 350, 'goomba').setScale(0.22);
            this.physics.add.collider(goomba1, platforms);
            this.physics.add.collider(goomba2, platforms);
            this.physics.add.collider(koopa1, platforms);
            this.physics.add.collider(player, platforms);
            this.physics.add.collider(player, tuberia);
            this.physics.add.collider(koopa1, player, muerte, null, this);
            this.physics.add.collider(caparazones, player, Cmuerte, null, this);
            this.physics.add.collider(goomba1, player, muerte, null, this);
            this.physics.add.collider(goomba2, player, muerte, null, this);
            this.physics.add.collider(goomba1, tuberia, rebote, null, this);
            this.physics.add.collider(goomba2, tuberia, rebote, null, this);
            this.physics.add.collider(koopa1, tuberia, rebote, null, this);

            this.physics.add.collider(caparazones, platforms);
            this.physics.add.collider(caparazones, tuberia, rebote, null, this);

            goomba1.setVelocityX(-160);
            goomba2.setVelocityX(160);
            cursors = this.input.keyboard.createCursorKeys();
            this.add.image(3970, 530, 'tuberiaTP').setScale(0.4);

            speed1 = Phaser.Math.GetSpeed(-600, 8);



            this.time.delayedCall(2500, goombasalta, [], this);


            

            this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('player', { start: 0, end: 4 }),
                frameRate: 10,
                repeat: 0
            });
            this.anims.create({
                key: 'goomba',
                frames: this.anims.generateFrameNumbers('goomba', { start: 0, end: 1 }),
                frameRate: 10,
                repeat: -1
            });
            goomba1.anims.play('goomba');
            goomba2.anims.play('goomba');

            this.anims.create({
                key: 'koopa',
                frames: [{ key: 'koopa', frame: 1 }],
                frameRate: 10,
            });

            this.anims.create({
                key: 'turn',
                frames: [{ key: 'player', frame: 6 }],
                frameRate: 10
            });
            player.anims.play('turn');

            this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('player', { start: 6, end: 11 }),
                frameRate: 10,
                //repeat: 1
            });
        }

        function update(time, delta) {

            koopa1.x += speed1 * delta;

            if (cursors.left.isDown) {
                player.setVelocityX(-160);
                player.anims.play('left', true);


            }
            else if (cursors.right.isDown) {
                player.setVelocityX(160);
                player.anims.play('right', true);

            }
            else {
                player.setVelocityX(0);
                player.anims.play('turn');

            }

            if (cursors.up.isDown && player.body.touching.down) {
                player.setVelocityY(-560);
            }
        }

        function rebote(goomba, tuberia) {
            if (toque == true) {
                goomba.setVelocityX(-160);
            }
            else { goomba.setVelocityX(160) }
            toque = !toque;
        }
        function goombasalta() {
            goomba1.setVelocityY(-400);
            goomba2.setVelocityY(-400);
            tiracaparazon();


            this.time.delayedCall(2500, goombasalta, [], this);

        }
        function tiracaparazon() {
            koopa1.setVelocityY(-400);
            
            capa= caparazones.create(koopa1.x, 500, 'caparazon').setScale(0.5);
            capa.setVelocityX(-250);
        }
        function soltarSeta() {
            setas.create(1300, 400, 'seta').setScale(1).refreshBody();
            setas.setVelocityX(250);

        }
        function cambioTamaño() {
            tamaño = "pequeño";
            player.clearTint(true);
        }
        function Cmuerte(player, enemy) {
            if (tamaño == "pequeño") {
                player.setVelocityY(-400);
                    this.physics.pause();
                    player.setTint(0xff0000);
                    speed1=0;
                    gameOver = true;
                }
                else {
                    player.setVelocityY(-400);
                    player.setScale(0.5);
                    player.tint = 0xff0000;

                    if (toque == true) {
                        enemy.setVelocityX(-160);
                    }
                    else { enemy.setVelocityX(160) }
                    toque = !toque;

                    this.time.delayedCall(1000, cambioTamaño, [], this);

                }
            
        }

        function muerte(enemy, player) {
            
                if (tamaño == "pequeño") {
                    player.setVelocityY(-400);
                    this.physics.pause();
                    
                    player.setTint(0xff0000);
                    speed1=0;
                    gameOver = true;
                }
                else {
                    player.setVelocityY(-400);
                    player.setScale(0.5);
                    player.tint = 0xff0000;

                    if (toque == true) {
                        enemy.setVelocityX(-160);
                    }
                    else { enemy.setVelocityX(160) }
                    toque = !toque;

                    this.time.delayedCall(1000, cambioTamaño, [], this);

                }
        }

    </script>

</body>

</html>